<div class="p-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="mb-1">Pembayaran</h1>
      <p class="text-muted">Kelola status pembayaran peserta di sini.</p>
    </div>
    <button
      class="btn text-white fw-600"
      style="background: linear-gradient(90deg, #667eea, #764ba2)"
      (click)="openModal()"
    >
      + Catat Pembayaran
    </button>
  </div>

  <div class="row g-3 mb-5">
    <div class="col-md-4">
      <div class="card border-0 shadow-sm">
        <div class="card-body d-flex gap-3 align-items-center">
          <div style="font-size: 2rem">ğŸ’¼</div>
          <div>
            <div class="text-muted small">Total Peserta</div>
            <div class="fs-5 fw-bold">{{ getTotalPeserta() }}</div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card border-0 shadow-sm">
        <div class="card-body d-flex gap-3 align-items-center">
          <div style="font-size: 2rem">âœ…</div>
          <div>
            <div class="text-muted small">Lunas</div>
            <div class="fs-5 fw-bold">{{ getLunasCount() }}</div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card border-0 shadow-sm">
        <div class="card-body d-flex gap-3 align-items-center">
          <div style="font-size: 2rem">â±ï¸</div>
          <div>
            <div class="text-muted small">Belum Lunas</div>
            <div class="fs-5 fw-bold">{{ getBelumLunasCount() }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-hover">
      <thead class="table-light">
        <tr>
          <th>Peserta</th>
          <th>Kelas</th>
          <th>Metode</th>
          <th>Status</th>
          <th>Riwayat Terakhir</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody>
        <!-- Tampilkan pembayaran yang ada -->
        <tr *ngFor="let p of pembayaranList">
          <td>
            <!-- tampilkan hanya nama peserta.
                 p.peserta biasanya disimpan seperti: "Nama (email)|Class".
                 Kita aman-kan dengan (p.peserta || '') sebelum split. -->
            <strong>{{ ((p.peserta || '').split('|')[0]).split(' (')[0] }}</strong>
          </td>
          <!-- jika p.classLevel kosong, fallback ke bagian setelah '|' di p.peserta -->
          <td>
            <span class="badge bg-info">{{ p.classLevel || ((p.peserta || '').split('|')[1] || '-') }}</span>
          </td>
          <td>{{ p.metode }}</td>
          <td>
            <span class="badge" [ngClass]="p.status === 'Lunas' ? 'bg-success' : 'bg-danger'">{{
              p.status
            }}</span>
          </td>
          <td>
            {{ formatRupiah(p.jumlah) }}<br />
            <small class="text-muted">{{ p.tanggal }}</small>
          </td>
          <td>
            <button class="btn btn-sm btn-primary me-2" (click)="openModal(p)">âœï¸ Edit</button>
            <button class="btn btn-sm btn-danger" (click)="deletePembayaran(p.id)">ğŸ—‘ï¸ Hapus</button>
          </td>
        </tr>

        <!-- Info jika tidak ada pembayaran -->
        <tr *ngIf="pembayaranList.length === 0">
          <td colspan="6" class="text-center text-muted py-3">Belum ada data pembayaran</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Daftar Peserta yang Belum Dibayar -->
  <div class="mt-5 pt-4 border-top">
    <h5 class="mb-3 fw-bold">Peserta yang Belum Ada di Pembayaran</h5>
    <div class="row g-3">
      <div class="col-md-6 col-lg-4">
        <div class="card h-100 border-0 shadow-sm">
          <div class="card-header" style="background: linear-gradient(90deg, #667eea, #764ba2); color: white;">
            <h6 class="mb-0">Beginner Level</h6>
          </div>
          <div class="card-body">
            <div *ngIf="getPesertaByClass('Beginner').length > 0; else noBeginner">
              <ul class="list-unstyled small">
                <li *ngFor="let member of getPesertaByClass('Beginner')" class="mb-2">
                  <input type="checkbox" class="form-check-input me-2" />
                  {{ member.name }} <br/>
                  <small class="text-muted">{{ member.email }}</small>
                </li>
              </ul>
            </div>
            <ng-template #noBeginner>
              <p class="text-muted small mb-0">Belum ada peserta</p>
            </ng-template>
          </div>
        </div>
      </div>

      <div class="col-md-6 col-lg-4">
        <div class="card h-100 border-0 shadow-sm">
          <div class="card-header" style="background: linear-gradient(90deg, #667eea, #764ba2); color: white;">
            <h6 class="mb-0">Intermediate Level</h6>
          </div>
          <div class="card-body">
            <div *ngIf="getPesertaByClass('Intermediate').length > 0; else noIntermediate">
              <ul class="list-unstyled small">
                <li *ngFor="let member of getPesertaByClass('Intermediate')" class="mb-2">
                  <input type="checkbox" class="form-check-input me-2" />
                  {{ member.name }} <br/>
                  <small class="text-muted">{{ member.email }}</small>
                </li>
              </ul>
            </div>
            <ng-template #noIntermediate>
              <p class="text-muted small mb-0">Belum ada peserta</p>
            </ng-template>
          </div>
        </div>
      </div>

      <div class="col-md-6 col-lg-4">
        <div class="card h-100 border-0 shadow-sm">
          <div class="card-header" style="background: linear-gradient(90deg, #667eea, #764ba2); color: white;">
            <h6 class="mb-0">Advanced Level</h6>
          </div>
          <div class="card-body">
            <div *ngIf="getPesertaByClass('Advanced').length > 0; else noAdvanced">
              <ul class="list-unstyled small">
                <li *ngFor="let member of getPesertaByClass('Advanced')" class="mb-2">
                  <input type="checkbox" class="form-check-input me-2" />
                  {{ member.name }} <br/>
                  <small class="text-muted">{{ member.email }}</small>
                </li>
              </ul>
            </div>
            <ng-template #noAdvanced>
              <p class="text-muted small mb-0">Belum ada peserta</p>
            </ng-template>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div
    class="modal"
    [class.show]="showModal"
    [style.display]="showModal ? 'block' : 'none'"
    tabindex="-1"
    (click)="closeModal()"
  >
    <div class="modal-dialog modal-lg" (click)="$event.stopPropagation()">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            {{ editingId ? 'Edit Pembayaran' : 'Catat Pembayaran' }}
          </h5>
          <button type="button" class="btn-close" (click)="closeModal()"></button>
        </div>
        <div class="modal-body">
          <div *ngIf="error" class="alert alert-danger">{{ error }}</div>
          <form>
            <div class="mb-3">
              <label class="form-label">Peserta</label>
              <select class="form-select" [(ngModel)]="peserta" name="peserta">
                <option value="">-- Pilih Peserta --</option>
                <optgroup label="Beginner Level">
                  <option *ngFor="let p of getPesertaByClass('Beginner')" 
                    [value]="p.name + ' (' + p.email + ')' + '|' + p.classLevel">
                    {{ p.name }} - {{ p.email }}
                  </option>
                </optgroup>
                <optgroup label="Intermediate Level">
                  <option *ngFor="let p of getPesertaByClass('Intermediate')" 
                    [value]="p.name + ' (' + p.email + ')' + '|' + p.classLevel">
                    {{ p.name }} - {{ p.email }}
                  </option>
                </optgroup>
                <optgroup label="Advanced Level">
                  <option *ngFor="let p of getPesertaByClass('Advanced')" 
                    [value]="p.name + ' (' + p.email + ')' + '|' + p.classLevel">
                    {{ p.name }} - {{ p.email }}
                  </option>
                </optgroup>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Jumlah (Rp)</label>
              <input type="number" class="form-control" [(ngModel)]="jumlah" name="jumlah" />
            </div>
            <div class="mb-3">
              <label class="form-label">Metode Pembayaran</label>
              <select class="form-select" [(ngModel)]="metode" name="metode">
                <option value="Transfer Bank">Transfer Bank</option>
                <option value="E-Wallet">E-Wallet</option>
                <option value="Cash">Cash</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Status</label>
              <select class="form-select" [(ngModel)]="status" name="status">
                <option value="Lunas">Lunas</option>
                <option value="Belum Lunas">Belum Lunas</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeModal()">Batal</button>
          <button
            type="button"
            class="btn text-white fw-600"
            style="background: linear-gradient(90deg, #667eea, #764ba2)"
            (click)="submit()"
          >
            {{ editingId ? 'Perbarui' : 'Simpan' }}
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-backdrop fade" [class.show]="showModal" *ngIf="showModal"></div>
</div>
